@using Newtonsoft.Json
@model Alman.Web.Models.LoginViewModel
@{
    ViewBag.Title = "Login";
    Layout = "~/Views/Shared/_LayoutLogin.cshtml";
}
<div class="container center-div">
    <p></p>
    <div class="row">
        <div class="col-lg-6 col-md-8 col-sm-10">            
            <h4>
                <span class="fa fa-user fa-2x"></span> Sign in to begin using ALMAN

            </h4>
        </div>
    </div>

    <hr style="margin-top:0;margin-bottom:10px" />

    <div class="row">
        <div class="col-lg-6 col-md-8 col-sm-10">
            <form id="login-form" role="form">

                <div class="form-group" data-bind="validationElement: FacilityCode">
                    <label class="control-label" for="facility">Facility Identifer</label>
                    <input id="facility"
                           class="form-control"
                           type="text"
                           data-bind="textinput: FacilityCode"                           
                           maxlength="20"
                           placeholder="ALMAN facility ID" required />
                    <span class="help-block" data-bind="validationMessage: FacilityCode"></span>
                </div>

                <div class="form-group" data-bind="validationElement: Username">
                    <label class="control-label" for="login-name">User Name</label>

                    <input id="login-name"
                           class="form-control"
                           type="email"
                           data-bind="textinput: Username"
                           placeholder="myaddress@gmail.com" required />
                    <span class="help-block" data-bind="validationMessage: Username">
                        <span class="fa fa-exclamation-triangle"></span>
                    </span>
                </div>

                <div class="form-group" data-bind="validationElement: Password">
                    <label class="control-label" for="login-password">Password</label>

                    <input id="login-password"
                           class="form-control"
                           maxlength="20"                           
                           type="password"
                           data-bind="textinput: Password"
                           placeholder="enter password" required />

                    <span class="help-block has-error" data-bind="validationMessage: Password">
                        <span class="fa fa-exclamation-circle"></span>
                     </span>
                </div>

                <button type="button" class="btn btn-primary" data-bind="click: home.login">
                    <span class="fa fa-sign-in"></span> Sign In
                </button>

                <a style="margin-left:20px" href="@Url.Action("ResetPassword", "Account")">I forgot my password</a>

            </form>
        </div>

    </div>
</div>

@section scripts {
    <script>

        $(function() {
            home.init();
            $("#facility").focus();
            ko.validation.init({                
                errorElementClass: 'has-error',
                errorMessageClass: 'help-block',
                decorateElement: true,
                insertMessages: false
            });
        });

        var home = {
            model: ko.observable(),

            init: function () {
                var serverModel = @Html.Raw(JsonConvert.SerializeObject(Model));
                if ( serverModel) {
                    var form = $("#container")[0];
                    home.model(ko.mapping.fromJS(serverModel));
                    home.model().Username.extend({ required: true, email: true });
                    home.model().Password.extend( { required: true });
                    home.model().FacilityCode.extend( { required: true, minLength:3 });
                   
                    ko.applyBindings(home.model, form);
                    ko.validation.init();
                   
                }
            },
            login: function() {

                if ( !home.model().Username.isValid())
                    return;
                if (!home.model().Password.isValid())
                    return;
                if (!home.model().FacilityCode.isValid())
                    return;

                var data = ko.mapping.toJSON(home.model);
                var url = "/Account/Login";

                $.ajax({
                    url: url,
                    data: data,
                    dataType: "json",
                    type: "POST",
                    contentType: "application/json; charset=utf-8"
                })
                .success(function (data, status, xhr) {
                    console.log("success");
                })
                .fail(function (errorMessage) {
                    console.log("failed");
                })

            }
        };

    </script>
}

